name: Release Provider

on:
    workflow_dispatch:
        inputs:
            version:
                description: "Version number (e.g., 0.1.0)"
                required: true
                type: string

permissions:
    contents: write
    id-token: write

jobs:
    release:
        name: Build and Release
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version: "1.25"

            - name: Set version and create tag
              id: version
              run: |
                  VERSION="${{ inputs.version }}"
                  # Remove 'v' prefix if present
                  VERSION=${VERSION#v}
                  TAG="v$VERSION"
                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "Version: $VERSION"
                  echo "Tag: $TAG"

                  # Create and push tag
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "$TAG" -m "Release $TAG"
                  git push origin "$TAG"

            - name: Run GoReleaser
              uses: goreleaser/goreleaser-action@v6
              with:
                  version: latest
                  args: release --clean
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  GPG_PRIVATE_KEY: ${{ secrets.HASHICORP_GPG_PRIVATE_KEY }}
                  GPG_PASSPHRASE: ${{ secrets.HASHICORP_GPG_PASSPHRASE }}
              if: ${{ steps.version.outputs.tag }}

            - name: Generate Terraform Registry Manifest
              env:
                  VERSION: ${{ steps.version.outputs.version }}
              run: |
                  cd dist
                  cat > terraform-registry-manifest.json <<EOF
                  {
                    "version": 1,
                    "metadata": {
                      "protocol_versions": ["5.0", "6.0"]
                    }
                  }
                  EOF
                  echo "Generated manifest file:"
                  cat terraform-registry-manifest.json

            - name: Format checksums for Terraform Registry
              env:
                  VERSION: ${{ steps.version.outputs.version }}
              run: |
                  cd dist
                  if [ -f "terraform-provider-n8n_${VERSION}_SHA256SUMS" ]; then
                    # Add asterisk prefix to each line (Terraform Registry requirement)
                    sed 's/^/*/' "terraform-provider-n8n_${VERSION}_SHA256SUMS" > "terraform-provider-n8n_${VERSION}_SHA256SUMS.tmp"
                    mv "terraform-provider-n8n_${VERSION}_SHA256SUMS.tmp" "terraform-provider-n8n_${VERSION}_SHA256SUMS"
                    echo "Formatted checksums file:"
                    cat "terraform-provider-n8n_${VERSION}_SHA256SUMS"
                  fi

            - name: Re-sign checksums after formatting
              env:
                  VERSION: ${{ steps.version.outputs.version }}
                  GPG_PRIVATE_KEY: ${{ secrets.HASHICORP_GPG_PRIVATE_KEY }}
                  GPG_PASSPHRASE: ${{ secrets.HASHICORP_GPG_PASSPHRASE }}
              run: |
                  if [ -n "$GPG_PRIVATE_KEY" ] && [ -f "dist/terraform-provider-n8n_${VERSION}_SHA256SUMS" ]; then
                    echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --pinentry-mode loopback --import
                    cd dist
                    # Use binary signature (no --armor flag) for Terraform Registry compatibility
                    gpg --detach-sign --batch --yes --pinentry-mode loopback --passphrase "$GPG_PASSPHRASE" --output "terraform-provider-n8n_${VERSION}_SHA256SUMS.sig" "terraform-provider-n8n_${VERSION}_SHA256SUMS"
                    echo "Re-signed checksums file with binary signature"
                  fi

            - name: Update release with formatted checksums and manifest
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.version.outputs.tag }}
                  files: |
                      dist/terraform-provider-n8n_*_SHA256SUMS*
                      dist/terraform-registry-manifest.json
                  overwrite_files: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              if: ${{ steps.version.outputs.tag }}
